<div class="px-4 pt-5 pb-14 font-inter">
  <div class="w-full max-w-md mx-auto space-y-5">
    <!-- Header -->
    <header class="flex items-center justify-end gap-3">
      <!-- Filtros rápidos -->
      <div class="flex items-center gap-2 bg-gray-50 rounded-full px-1 py-1">
        <button
          type="button"
          class="px-3 py-1 rounded-full text-[11px] font-medium border transition-colors duration-150 active:scale-95"
          [ngClass]="
            filtroStatus === 'TODAS'
              ? 'bg-primary text-white border-primary'
              : 'bg-white text-description border-transparent'
          "
          (click)="filtroStatus = 'TODAS'; resetPage()"
        >
          Todas
        </button>

        <button
          type="button"
          class="px-3 py-1 rounded-full text-[11px] font-medium border transition-colors duration-150 active:scale-95"
          [ngClass]="
            filtroStatus === 'EM_ANDAMENTO'
              ? 'bg-[#2563EB]/10 text-blue border-[#2563EB]/40'
              : 'bg-white text-description border-transparent'
          "
          (click)="filtroStatus = 'EM_ANDAMENTO'; resetPage()"
        >
          Em andamento
        </button>

        <button
          type="button"
          class="px-3 py-1 rounded-full text-[11px] font-medium border transition-colors duration-150 active:scale-95"
          [ngClass]="
            filtroStatus === 'CONCLUIDAS'
              ? 'bg-success/10 text-success border-success/40'
              : 'bg-white text-description border-transparent'
          "
          (click)="filtroStatus = 'CONCLUIDAS'; resetPage()"
        >
          Concluídas
        </button>
      </div>
    </header>

    <!-- Nova Meta -->
    <section>
      <app-button-primary
        [label]="'Nova meta'"
        [type]="'button'"
        (clicked)="openCreateMetaModal()"
      ></app-button-primary>
    </section>

    <!-- Conteúdo -->
    <section class="space-y-4">
      <div
        *ngIf="loadingMetas"
        class="text-center text-sm text-description py-6"
      >
        Carregando metas…
      </div>

      <div
        *ngIf="!loadingMetas && loadErrorMessage"
        class="text-center text-xs text-error bg-red-50 border border-red-100 rounded-xl px-4 py-3"
      >
        {{ loadErrorMessage }}
      </div>

      <ng-container *ngIf="!loadingMetas">
        <ng-container *ngIf="pagedMetas.length > 0; else semMetas">
          <div class="space-y-4">
            <article
              *ngFor="let meta of pagedMetas"
              class="rounded-xl p-4 border shadow-sm active:scale-[0.98] transition"
              [ngClass]="
                meta.concluida
                  ? 'bg-success/5 border-success/40'
                  : 'bg-white border-black/5'
              "
            >
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0 flex-1">
                  <p class="font-semibold text-sm text-black uppercase">
                    {{ meta.nome }}
                  </p>
                  <p class="text-sm text-description">
                    {{ formatDate(meta.dataAlvo) }}
                  </p>
                  <p
                    *ngIf="!meta.concluida"
                    class="text-[10px] text-description"
                  >
                    {{
                      getDaysUntilTarget(meta) >= 0
                        ? getDaysUntilTarget(meta) + " dias restantes"
                        : "Prazo vencido"
                    }}
                  </p>
                </div>

                <div class="text-right space-y-1">
                  <p class="font-bold text-sm text-gray-900">
                    {{
                      meta.valorAtual
                        | currency : "BRL" : "symbol" : "1.2-2" : "pt"
                    }}
                  </p>
                  <p class="text-[11px] text-description">
                    de
                    {{
                      meta.valorAlvo
                        | currency : "BRL" : "symbol" : "1.2-2" : "pt"
                    }}
                  </p>
                </div>
              </div>

              <!-- Progresso -->
              <div class="mt-3">
                <div
                  class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden"
                >
                  <div
                    class="h-full rounded-full transition-all duration-300"
                    [style.width.%]="getProgressPercentage(meta)"
                    [style.background-image]="
                      'linear-gradient(90deg, ' +
                      getMetaProgressColor(meta) +
                      '33, ' +
                      getMetaProgressColor(meta) +
                      ')'
                    "
                  ></div>
                </div>
                <div
                  class="mt-1 flex items-center justify-between text-[11px] text-description"
                >
                  <span
                    >{{ getProgressPercentage(meta) | number : "1.0-0" }}%
                    concluído</span
                  >
                </div>
              </div>

              <!-- Aporte -->
              <div class="flex items-center justify-between mt-3">
                <!-- Quando não concluída: ícone de remover aporte e botão de aporte -->
                <ng-container *ngIf="!meta.concluida; else metaConcluida">
                  <button
                    *ngIf="meta.aportes && meta.aportes.length > 0"
                    type="button"
                    (click)="openRemoveAporteModal(meta)"
                    class="p-2.5 rounded-lg text-error hover:bg-error/10 active:scale-95 transition "
                    aria-label="Remover aporte"
                  >
                    <mat-icon class="text-xl">delete</mat-icon>
                  </button>
                  <div *ngIf="!(meta.aportes && meta.aportes.length > 0)"></div>
                  <button
                    type="button"
                    (click)="openAporteModal(meta)"
                    class="px-4 py-2 rounded-lg bg-primary text-white text-xs font-semibold active:scale-95 transition"
                  >
                    Fazer aporte
                  </button>
                </ng-container>
                <!-- Quando concluída: selo ocupando o lugar do botão -->
                <ng-template #metaConcluida>
                  <div></div>
                  <div
                    class="px-4 py-2 rounded-lg bg-success/10 text-success text-xs font-semibold"
                  >
                    Meta concluída
                  </div>
                </ng-template>
              </div>
            </article>

            <div *ngFor="let _ of placeholders" class="h-32"></div>
          </div>

          <!-- Paginação -->
          <div *ngIf="totalItems > pageSize" class="pt-2 space-y-2">
            <div class="flex justify-between text-[11px] text-description">
              <span> {{ pageStart }}–{{ pageEnd }} de {{ totalItems }} </span>
              <span>Página {{ currentPage }} de {{ totalPages }}</span>
            </div>

            <div class="flex justify-end gap-2">
              <button
                type="button"
                (click)="previousPage()"
                [disabled]="currentPage === 1"
                class="h-8 w-8 rounded-full border border-gray-300 bg-white flex items-center justify-center disabled:opacity-40 active:scale-95 transition"
              >
                <mat-icon class="text-sm">chevron_left</mat-icon>
              </button>

              <button
                type="button"
                (click)="nextPage()"
                [disabled]="currentPage === totalPages"
                class="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center disabled:opacity-40 active:scale-95 transition"
              >
                <mat-icon class="text-sm">chevron_right</mat-icon>
              </button>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <ng-template #semMetas>
        <div
          class="text-center py-12 text-description font-semibold bg-white rounded-2xl border border-dashed border-gray-200"
        >
          Nenhuma meta encontrada.
        </div>
      </ng-template>
    </section>
  </div>

  <!-- Modais -->
  <app-create-meta-modal
    [open]="isCreateMetaModalOpen"
    (close)="handleCreateMetaModalClose()"
    (confirm)="handleCreateMetaModalConfirm($event)"
  />

  <app-add-aporte-modal
    [open]="isAporteModalOpen"
    [meta]="selectedMetaForAporte"
    (close)="handleAporteModalClose()"
    (confirm)="handleAporteModalConfirm($event)"
  />

  <app-remove-aporte-modal
    [open]="isRemoveAporteModalOpen"
    [meta]="selectedMetaForRemoveAporte"
    (close)="handleRemoveAporteModalClose()"
    (confirm)="handleRemoveAporteModalConfirm($event)"
    (deleteMeta)="handleRemoveAporteModalDeleteMeta($event)"
  />

  <!-- Modal de confirmação de exclusão de meta -->
  <app-confirm-modal
    [open]="isConfirmDeleteMetaOpen"
    [title]="'Excluir meta'"
    [description]="getDeleteMetaDescription()"
    [confirmLabel]="'Excluir'"
    [cancelLabel]="'Cancelar'"
    [confirming]="deletingMeta"
    (close)="handleConfirmDeleteMetaClose()"
    (confirm)="confirmDeleteMeta()"
  ></app-confirm-modal>
</div>

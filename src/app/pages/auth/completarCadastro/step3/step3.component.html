<section class="flex flex-col gap-6">
  <header class="flex flex-col gap-3">
    <h1 class="text-4xl font-bold text-primary">
      Informe seus <span class="text-error">gastos</span> mensais fixos
    </h1>

    <ul *ngIf="finalizedExpenses.length" class="w-full space-y-2">
      <li
        *ngFor="let exp of finalizedExpenses; let idx = index"
        class="flex items-center justify-between rounded-lg bg-white/60 px-3 py-2"
      >
        <div class="text-sm text-primary">
          <span class="font-semibold">
            {{ exp.value | currency : "BRL" : "symbol" : "1.2-2" }}
          </span>
          <span class="mx-1">•</span>
          <span>{{ getCategoriaNome(exp.categoriaId) }}</span>
          <span class="mx-1">•</span>
          <span>Dia {{ exp.day }}</span>
        </div>
        <button
          type="button"
          class="text-error"
          aria-label="Remover gasto"
          (click)="deleteFinalized(idx)"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </li>
    </ul>
  </header>

  <form class="flex flex-col gap-6" (ngSubmit)="onContinue()">
    <div class="flex flex-col gap-2">
      <app-ui-input
        id="value-current-expense"
        [(ngModel)]="currentExpense.value"
        name="value-current-expense"
        placeholder="0,00"
        [useMask]="true"
        mask="separator.2"
        thousandSeparator="."
        decimalMarker=","
        [dropSpecialCharacters]="false"
        prefix="R$"
        inputMode="decimal"
      />
    </div>

    <div class="flex flex-row justify-around gap-4 flex-wrap">
      <div class="flex flex-col gap-2">
        <div class="relative">
          <select
            id="category-current-expense"
            [(ngModel)]="currentExpense.categoriaId"
            name="category-current-expense"
            class="border-0 rounded-lg px-4 py-3 pr-10 bg-primary outline-none font-bold text-white appearance-none w-full"
          >
            <option class="bg-white text-primary" value="">Categoria</option>
            <option
              class="bg-white text-primary"
              *ngFor="let cat of categoriasDespesa"
              [value]="cat.id"
            >
              {{ cat.nome }}
            </option>
          </select>
          <mat-icon
            class="pointer-events-none !text-white absolute right-3 top-1/2 -translate-y-1/2 select-none"
            >expand_more</mat-icon
          >
        </div>
        <p
          *ngIf="categoriasDespesa.length === 0"
          class="text-xs text-error text-center"
        >
          Nenhuma categoria de despesa disponível.
        </p>
      </div>

      <div class="flex flex-row items-center gap-2">
        <button
          type="button"
          id="day-current-expense"
          name="day-current-expense"
          (click)="openDayModal()"
          class="border-0 rounded-md px-6 py-3 bg-primary outline-none font-bold text-white flex items-center gap-1"
          aria-haspopup="dialog"
          [attr.aria-expanded]="showDayModal ? 'true' : 'false'"
        >
          {{ currentExpense.day ? "Dia " + currentExpense.day : "Dia" }}
        </button>
      </div>
    </div>

    <ng-container *ngIf="showDayModal">
      <div
        class="fixed inset-0 bg-black/40 z-40"
        (click)="closeDayModal()"
      ></div>
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
          class="w-full max-w-sm mx-2 rounded-lg bg-white px-4 py-8 shadow-lg"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-primary">Selecione o dia</h2>
            <button
              type="button"
              (click)="closeDayModal()"
              aria-label="Fechar"
              class="text-primary"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div class="grid grid-cols-7 gap-2">
            <button
              type="button"
              *ngFor="let day of days"
              (click)="selectDay(day)"
              class="rounded-md px-2 py-2 text-sm font-bold border"
              [ngClass]="{
                'bg-primary text-white border-primary': isDaySelected(day),
                'bg-white text-primary border-primary hover:bg-primary hover:text-white':
                  !isDaySelected(day)
              }"
            >
              {{ day }}
            </button>
          </div>
        </div>
      </div>
    </ng-container>

    <button
      type="button"
      (click)="addExpense()"
      [disabled]="!isCurrentExpenseValid()"
      class="border-0 rounded px-4 py-2 text-lg flex gap-2 items-center justify-center text-primary font-bold"
    >
      <img src="/assets/adicionar.png" alt="Adicionar" /> Adicionar outro gasto
    </button>

    <app-button-primary
      type="submit"
      label="Continuar"
      [disabled]="!isFormValid()"
    />
  </form>
</section>
